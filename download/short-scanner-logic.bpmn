<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
  id="Definitions_1"
  targetNamespace="http://bpmn.io/schema/bpmn"
  exporter="Short Scanner"
  exporterVersion="1.0">
  
  <bpmn:process id="ShortScanner" name="SHORT Scanner Logic" isExecutable="false">
    
    <!-- START -->
    <bpmn:startEvent id="Start" name="Scan Request"/>
    
    <!-- MAIN FLOW -->
    <bpmn:task id="GetGainers" name="Get Top Gainers&#10;from Exchange"/>
    <bpmn:exclusiveGateway id="HasGainers" name="Gainers found?"/>
    
    <!-- PER TICKER SUBPROCESS -->
    <bpmn:subProcess id="AnalyzeTicker" name="Analyze Ticker">
      
      <!-- FETCH DATA -->
      <bpmn:startEvent id="StartAnalyze"/>
      <bpmn:parallelGateway id="FetchParallel" name="Fetch Data Parallel"/>
      
      <bpmn:task id="FetchCandles" name="Fetch Candles&#10;(5m/15m/1h/2h/4h)"/>
      <bpmn:task id="FetchPerpetual" name="Fetch Perpetual Data&#10;(Funding/OI/L-S Ratio)"/>
      <bpmn:task id="FetchOrderBook" name="Fetch Order Book&#10;&amp; Liquidation Heatmap"/>
      
      <bpmn:parallelGateway id="FetchJoin" name="Join"/>
      
      <!-- CALCULATE INDICATORS -->
      <bpmn:task id="CalcIndicators" name="Calculate Indicators&#10;(RSI/MACD/EMA/BB/ATR/VWAP/ADX)"/>
      
      <!-- TIER DETECTION SUBPROCESS -->
      <bpmn:subProcess id="DetectTIER" name="Detect TIER">
        
        <bpmn:startEvent id="StartTIER"/>
        
        <bpmn:exclusiveGateway id="CheckOverride" name="In Override List?"/>
        <bpmn:task id="GetOverrideTIER" name="Get Override TIER"/>
        
        <bpmn:task id="CalcATR" name="Calculate ATR&#10;(24h/7d/14d)"/>
        <bpmn:task id="CalcVolume" name="Calculate Volume Ratio&#10;(current/avg)"/>
        
        <bpmn:task id="CombineTiers" name="Combine Tiers&#10;(50% hist + 30% curr + 20% price)"/>
        
        <bpmn:exclusiveGateway id="CheckVolume" name="Volume Adjustment Needed?"/>
        <bpmn:task id="AdjustVolume" name="Adjust TIER by Volume"/>
        
        <bpmn:task id="CheckNewCoin" name="Check if New Coin&#10;(&lt;50 candles)"/>
        
        <bpmn:endEvent id="EndTIER" name="TIER Determined"/>
        
        <!-- TIER Flow -->
        <bpmn:sequenceFlow id="s1" sourceRef="StartTIER" targetRef="CheckOverride"/>
        <bpmn:sequenceFlow id="s2" sourceRef="CheckOverride" targetRef="GetOverrideTIER">
          <bpmn:conditionExpression>inOverrideList</bpmn:conditionExpression>
        </bpmn:sequenceFlow>
        <bpmn:sequenceFlow id="s3" sourceRef="CheckOverride" targetRef="CalcATR">
          <bpmn:conditionExpression>!inOverrideList</bpmn:conditionExpression>
        </bpmn:sequenceFlow>
        <bpmn:sequenceFlow id="s4" sourceRef="GetOverrideTIER" targetRef="CalcVolume"/>
        <bpmn:sequenceFlow id="s5" sourceRef="CalcATR" targetRef="CalcVolume"/>
        <bpmn:sequenceFlow id="s6" sourceRef="CalcVolume" targetRef="CombineTiers"/>
        <bpmn:sequenceFlow id="s7" sourceRef="CombineTiers" targetRef="CheckVolume"/>
        <bpmn:sequenceFlow id="s8" sourceRef="CheckVolume" targetRef="AdjustVolume">
          <bpmn:conditionExpression>volumeRatio &gt; 3 OR volumeRatio &lt; 0.3</bpmn:conditionExpression>
        </bpmn:sequenceFlow>
        <bpmn:sequenceFlow id="s9" sourceRef="CheckVolume" targetRef="CheckNewCoin">
          <bpmn:conditionExpression>normalVolume</bpmn:conditionExpression>
        </bpmn:sequenceFlow>
        <bpmn:sequenceFlow id="s10" sourceRef="AdjustVolume" targetRef="CheckNewCoin"/>
        <bpmn:sequenceFlow id="s11" sourceRef="CheckNewCoin" targetRef="EndTIER"/>
        
      </bpmn:subProcess>
      
      <!-- SCORE & SETUP -->
      <bpmn:task id="CalcShortScore" name="Calculate SHORT Score&#10;(using TIER config)"/>
      <bpmn:task id="DetectSetup" name="Detect Setup Type&#10;(Divergence/FakePump/etc)"/>
      <bpmn:task id="CalcLevels" name="Calculate Trade Levels&#10;(Entry/SL/TP1/TP2)"/>
      <bpmn:task id="GenAnalysis" name="Generate Analysis&#10;&amp; Recommendations"/>
      
      <bpmn:endEvent id="EndAnalyze" name="Ticker Analyzed"/>
      
      <!-- Analyze Flow -->
      <bpmn:sequenceFlow id="a1" sourceRef="StartAnalyze" targetRef="FetchParallel"/>
      <bpmn:sequenceFlow id="a2" sourceRef="FetchParallel" targetRef="FetchCandles"/>
      <bpmn:sequenceFlow id="a3" sourceRef="FetchParallel" targetRef="FetchPerpetual"/>
      <bpmn:sequenceFlow id="a4" sourceRef="FetchParallel" targetRef="FetchOrderBook"/>
      <bpmn:sequenceFlow id="a5" sourceRef="FetchCandles" targetRef="FetchJoin"/>
      <bpmn:sequenceFlow id="a6" sourceRef="FetchPerpetual" targetRef="FetchJoin"/>
      <bpmn:sequenceFlow id="a7" sourceRef="FetchOrderBook" targetRef="FetchJoin"/>
      <bpmn:sequenceFlow id="a8" sourceRef="FetchJoin" targetRef="CalcIndicators"/>
      <bpmn:sequenceFlow id="a9" sourceRef="CalcIndicators" targetRef="DetectTIER"/>
      <bpmn:sequenceFlow id="a10" sourceRef="DetectTIER" targetRef="CalcShortScore"/>
      <bpmn:sequenceFlow id="a11" sourceRef="CalcShortScore" targetRef="DetectSetup"/>
      <bpmn:sequenceFlow id="a12" sourceRef="DetectSetup" targetRef="CalcLevels"/>
      <bpmn:sequenceFlow id="a13" sourceRef="CalcLevels" targetRef="GenAnalysis"/>
      <bpmn:sequenceFlow id="a14" sourceRef="GenAnalysis" targetRef="EndAnalyze"/>
      
    </bpmn:subProcess>
    
    <!-- FILTER & SORT -->
    <bpmn:task id="Filter" name="Apply Filters&#10;(minConfidence/minPriceChange/etc)"/>
    <bpmn:task id="Sort" name="Sort by Selected Option&#10;(confidence/score/volume)"/>
    
    <!-- END -->
    <bpmn:endEvent id="End" name="Return Candidates"/>
    
    <!-- ERROR PATH -->
    <bpmn:endEvent id="NoGainers" name="No Gainers Found"/>
    
    <!-- Main Flow Connections -->
    <bpmn:sequenceFlow id="f1" sourceRef="Start" targetRef="GetGainers"/>
    <bpmn:sequenceFlow id="f2" sourceRef="GetGainers" targetRef="HasGainers"/>
    <bpmn:sequenceFlow id="f3" sourceRef="HasGainers" targetRef="AnalyzeTicker">
      <bpmn:conditionExpression>gainers.length &gt; 0</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="f4" sourceRef="HasGainers" targetRef="NoGainers">
      <bpmn:conditionExpression>gainers.length == 0</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="f5" sourceRef="AnalyzeTicker" targetRef="Filter"/>
    <bpmn:sequenceFlow id="f6" sourceRef="Filter" targetRef="Sort"/>
    <bpmn:sequenceFlow id="f7" sourceRef="Sort" targetRef="End"/>
    
  </bpmn:process>
  
  <!-- DIAGRAM -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="ShortScanner">
      
      <!-- Start -->
      <bpmndi:BPMNShape id="Start_di" bpmnElement="Start">
        <dc:Bounds x="152" y="232" width="36" height="36"/>
      </bpmndi:BPMNShape>
      
      <!-- Get Gainers -->
      <bpmndi:BPMNShape id="GetGainers_di" bpmnElement="GetGainers">
        <dc:Bounds x="240" y="210" width="100" height="80"/>
      </bpmndi:BPMNShape>
      
      <!-- Has Gainers Gateway -->
      <bpmndi:BPMNShape id="HasGainers_di" bpmnElement="HasGainers" isMarkerVisible="true">
        <dc:Bounds x="395" y="232" width="50" height="50"/>
      </bpmndi:BPMNShape>
      
      <!-- Analyze Ticker Subprocess -->
      <bpmndi:BPMNShape id="AnalyzeTicker_di" bpmnElement="AnalyzeTicker" isExpanded="true">
        <dc:Bounds x="520" y="80" width="600" height="340"/>
      </bpmndi:BPMNShape>
      
      <!-- Filter -->
      <bpmndi:BPMNShape id="Filter_di" bpmnElement="Filter">
        <dc:Bounds x="1200" y="210" width="100" height="80"/>
      </bpmndi:BPMNShape>
      
      <!-- Sort -->
      <bpmndi:BPMNShape id="Sort_di" bpmnElement="Sort">
        <dc:Bounds x="1360" y="210" width="100" height="80"/>
      </bpmndi:BPMNShape>
      
      <!-- End -->
      <bpmndi:BPMNShape id="End_di" bpmnElement="End">
        <dc:Bounds x="1520" y="232" width="36" height="36"/>
      </bpmndi:BPMNShape>
      
      <!-- No Gainers -->
      <bpmndi:BPMNShape id="NoGainers_di" bpmnElement="NoGainers">
        <dc:Bounds x="402" y="342" width="36" height="36"/>
      </bpmndi:BPMNShape>
      
      <!-- Edges -->
      <bpmndi:BPMNEdge id="e1" bpmnElement="f1">
        <di:waypoint x="188" y="250"/>
        <di:waypoint x="240" y="250"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="e2" bpmnElement="f2">
        <di:waypoint x="340" y="250"/>
        <di:waypoint x="395" y="257"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="e3" bpmnElement="f3">
        <di:waypoint x="445" y="257"/>
        <di:waypoint x="520" y="250"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="e4" bpmnElement="f4">
        <di:waypoint x="420" y="282"/>
        <di:waypoint x="420" y="342"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="e5" bpmnElement="f5">
        <di:waypoint x="1120" y="250"/>
        <di:waypoint x="1200" y="250"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="e6" bpmnElement="f6">
        <di:waypoint x="1300" y="250"/>
        <di:waypoint x="1360" y="250"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="e7" bpmnElement="f7">
        <di:waypoint x="1460" y="250"/>
        <di:waypoint x="1520" y="250"/>
      </bpmndi:BPMNEdge>
      
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
  
</bpmn:definitions>
